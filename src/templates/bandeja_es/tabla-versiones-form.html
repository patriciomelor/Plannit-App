{% extends 'index-blank.html' %}

{% load static %}

{% load crispy_forms_tags %}

{% block content %}
<div class="br-mainpanel" style="position: relative;">

 <div class="pd-10 bg-gray-900 rounded">
            <ul class="nav nav-pills nav-pills-for-dark flex-column flex-md-row" style="margin-left:auto;margin-right:auto;"role="tablist">
              <li class="nav-item"><a href="{% url 'paquete-preview' %}" class="btn btn-warning bd-0 btn-compose" role="tab">Nuevo Transmittal</a></li>
              <li class="nav-item"><a href="{% url 'Bandejaeys' %}" class="nav-link mg-l-15"><i class="icon fa fa-reply"></i> Recibidos</a></li>
              <li class="nav-item"><a href="{% url 'bandeja-enviados' %}" class="nav-link mg-l-15"><i class="icon fa fa-share"></i> Enviados</a></li>
              <li class="nav-item"><a href="{% url 'Borradores' %}" class="nav-link mg-l-15"><i class="icon icon ion-edit"></i> Borradores</a></li>
            </ul>
</div>

<div class="br-pagebody pd-x-20 pd-sm-x-30">
    <div class="card bd-0 shadow-base">
        <div class="br-section-wrapper" style="padding: 30px;">
         <form method="post" class="form-group mg-t-20" id="form_paquete" >{% csrf_token %}

                <div id="wizard2" role="application" class="wizard clearfix">
                        <div class="steps clearfix">
                            <ul role="tablist">
                                <li role="tab"  class="disabled" aria-disabled="false" aria-selected="true">
                                    <a id="wizard2-t-0" href="#wizard2-h-0" aria-controls="wizard2-p-0">
                                        <span class="current-info audible">Paso: </span>
                                        <span class="number">1</span> 
                                        <span class="title">Configurar Destinatarios</span>
                                    </a>
                                </li>
                                <li role="tab"class="first current" aria-disabled="true">
                                        <a id="wizard2-t-1" href="#wizard2-h-1" aria-controls="wizard2-p-1">
                                            <span class="number">2</span> 
                                            <span class="title">Adjuntar Archivos</span>
                                        </a>
                                    </li>        
                            </ul>            
                        </div>
                        <div class="col-md-12 row " >
                          <div class="col-md-6" >
                         
                              <div id="tablaVersiones" style="background-color: rgba(176, 182, 176, 0.603); border-radius: 3px; padding: 10px;" >
                                  <table class="records_list table table-striped table-bordered table-hover dataTable no-footer table-primary" style="width:100%;">
                                      <thead>
                                          <tr>
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"> Código </th>
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"> Descripción </th>
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"> Especialidad </th>
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"> Revisión </th>
                                               {% if request.user.perfil.rol_usuario >= 4 and request.user.perfil.rol_usuario < 6  %}                                                       
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"> Estado </th>
                                                    
                                               {% elif request.user.perfil.rol_usuario >= 1 and request.user.perfil.rol_usuario < 3 %}
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"> Estado </th>                  
                                               {% endif %}  
                                              
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"></th>
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"></th>


                                          </tr>
                                      </thead>
                                        <tbody>
                                        {% for version in versiones %}
                                            <tr>
                                              <td style="text-align: center;border: 2px;border-color: grey; color: black;" > {{version.prev_documento_fk}} </td>
                                              <td style="text-align: center;border: 2px;border-color: grey; color: black;" > {{version.prev_documento_fk.Descripcion}} </td>
                                              <td style="text-align: center;border: 2px;border-color: grey; color: black;" > {{version.prev_documento_fk.Especialidad}} </td>
                                              <td style="text-align: center;border: 2px;border-color: grey; color: black;"> {{version.get_prev_revision_display}} </td>
                                               {% if request.user.perfil.rol_usuario >= 4 and request.user.perfil.rol_usuario < 6  %}                                                       
                                              <td style="text-align: center;border: 2px;border-color: grey; color: black;"> {{version.get_prev_estado_contratista_display}} </td>
                                                    
                                                   
                                               {% elif request.user.perfil.rol_usuario >= 1 and request.user.perfil.rol_usuario < 3 %}
                                                      <td style="text-align: center;border: 2px;border-color: grey; color: black;"> {{version.get_prev_estado_cliente_display}} </td>
                                                   
                                               {% endif %}  
                                              <td style="text-align: center;border: 2px;border-color: grey; color: black;"> <a onclick="JavaScript:window.open('{% url 'popup-version-update' version.pk paquete_pk %}','subir datos','toolbar=no,status=no,scrollbars=no,location=no,menubar=no,directories=no,resizable=yes,width=450,height=620,top=100,left=600');"><i class="fa fa-pencil"></i></a> </td>
                                              <td style="text-align: center;border: 2px;border-color: grey; color: black;"> <a href="{% url 'delete-prev-version' version.pk paquete_pk %}" onclick="confirm('Estás por eliminar esta versión. Estás seguro ?')"><i class="icon ion-trash-a"></i></a></td>

                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                        <a class="btn btn-warning" type="button" onclick="JavaScript:window.open('{% url 'popup-version' paquete_pk %}','subir datos','toolbar=no,status=no,scrollbars=no,location=no,menubar=no,directories=no,resizable=yes,width=450,height=620,top=100,left=600');"><i class="icon ion-plus mg-r-2"></i> Agregar Versión</a>
                     
                                    </table>
                                    <input type="submit" class="btn btn-teal mg-t-30 mg-b-30 float-left" value="Enviar"/>
                                    <a href="{% url 'borrador-crear' paquete_pk %}"><button type="button" class="btn btn-primary mg-t-30 mg-l-20 mg-b-30 float-left"><i class="icon ion-bookmark mg-r-2"></i> Guardar en Borrador</button></a>
                                   
                              </div>
                             
                          </div>
                          <div class="col-md-6">
                        
                               <div id="tablaVersiones"style="background-color: rgba(176, 182, 176, 0.603); border-radius: 3px; padding: 10px;overflow: scroll;">
                                <div id="app">
                                  
                                  <table class="records_list table table-striped table-bordered table-hover dataTable no-footer table-primary" style="width:100%;">
                                      <thead>
                                          <tr>
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"> Código </th>
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"> Descripción </th>
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"> Especialidad </th>
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"> Revisión </th>
                                               {% if request.user.perfil.rol_usuario >= 4 and request.user.perfil.rol_usuario < 6  %}                                                       
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"> Estado </th>
                                                    
                                               {% elif request.user.perfil.rol_usuario >= 1 and request.user.perfil.rol_usuario < 3 %}
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"> Estado </th>                  
                                               {% endif %}  
                                              
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;">Campo</th>
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"></th>
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"></th>


                                          </tr>
                                      </thead>
                                      
                                        <tbody>
                                         
                                            <tr v-for="version in versiones" :key="version.Codigo_documento">
                                                <td > [[ version.Codigo_documento ]]</td>
                                                <td > [[ version.Descripcion ]]</td>
                                                <td > [[ version.Especialidad ]]</td>
                                                <td > [[ version.Tipo_Documento ]]</td>
                                                <td > [[ version.fecha_Emision_0 ]]</td>
                                                <td > [[ version.fecha_Emision_B ]]</td>
                                                <td><input type="file" name="file" id="file"></td>
                                                <td style="text-align: center;border: 2px;border-color: grey; color: black;"> 
                                                    <!-- <a v-if="send == 0" @click="cargar_val(version)" >
                                                        <i class="fa fa-upload"></i>
                                                    </a>  -->

                                                    <div v-bind:class="spinner-border text-primary" role="status">
                                                        <i class="fa fa-upload"></i>
                                                    </div>
                                                </td>
                                                <td style="text-align: center;border: 2px;border-color: grey; color: black;"> <a href="" ><i class="icon ion-trash-a"></i></a></td>
                                            </tr>  

                                        </tbody>
                                        <input type="file" name="file" id="file">
                                          <button @click="adjuntar_arch" class="btn btn-warning" type="button" :disabled="loading == 1">
                                            <span v-if="loading == 1" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                                [[ buttonText ]]
                                          </button>
                                          
                                        <a v-on:click="cargar_val" class="btn btn-primary" type="button"><i class="icon ion-plus mg-r-2"></i> Cargar Versiones </a>
                     
                                    </table>
                                </div>
                                    
                                </div>
                        
                        </div>
                        </div>      
                     </div>
                
            </form>
        </div>
    </div>     

</div>
  
  </div>
<script language='javascript'>
var t;
function doLoad() {
t = setTimeout("window.close()",1000);
}

</script>
<script type="text/javascript">
function refreshAndClose() {
    window.opener.location.reload(true);
    window.close();
}
</script>
<script>
    window.onunload = refreshParent;
    function refreshParent() {
      window.opener.location.reload();
    }
</script>
<script>

var app = new Vue({
    
  el: '#app',
  delimiters: [ '[[' ,  ']]' ],
  data: {
    versiones: [],
    loading: 0,
    send: 0,
    buttonText : 'Subir Archivo',
    
  },
  methods:{
    adjuntar_arch: function() {
        this.loading = 1;
        this.buttonText = 'Subiendo...';

        let formData = new FormData();
        const file = document.getElementById('file')
        formData.append('file', file.files[0]);

        fetch("{% url 'vue-file-import' %}", {
            method: 'POST',
            body: formData
        }).then(
            async response => {
                const result = await response.json();
                this.versiones = result.data;
                console.log(this.versiones)
                this.loading = 0;
                this.buttonText = 'Subir Archivo';

                }
        ).catch(
            error => {
                console.log('Error:', error);
                this.loading = 0;
                this.buttonText = 'Subir Archivo';

            }
        )
    },

    cargar_val: function(version) {
        this.send = 1;

        let formData = new FormData();
        formData.append('Codigo_documento', version['Codigo_documento'])
        formData.append('Descripcion', version['Descripcion'])
        formData.append('Especialidad', version['Especialidad'])
        formData.append('Tipo_Documento', version['Tipo_Documento'])
        formData.append('fecha_Emision_0', version['fecha_Emision_0'])
        formData.append('fecha_Emision_B', version['fecha_Emision_B'])

        console.log(formData);

        fetch("{% url 'vue-version-check' %}", {
            method: 'POST',
            body: formData
        }).then(
            response => {
                const result = response.json();

                console.log(result);
                this.send = 0;

                }
        ).catch(
            error => {
                console.log(error);
            }
        )


        
    }
    
  }
})
</script>

<!-- <script>
    Vue.component('message', {
        template: '#message',
        props: {
            type: {
                type: String
            },
            header: {
                type: String
            },
        }, 

    })


</script> -->
{% endblock content %}