{% extends 'index-blank.html' %}

{% load static %}

{% load crispy_forms_tags %}

{% block content %}
<style>
    /**********File Inputs**********/
   
    
    .inputfile {
        width: 0.1px;
        height: 0.1px;
        opacity: 0;
        overflow: hidden;
        position: absolute;
        z-index: -1;
    }
    
    .inputfile + label {
        max-width: 80%;
        font-size: 1.25rem;
        font-weight: 700;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: pointer;
        display: inline-block;
        overflow: hidden;
        padding: 0.625rem 1.25rem;
    }
    
    .inputfile + label svg {
        width: 1em;
        height: 1em;
        vertical-align: middle;
        fill: currentColor;
        margin-top: -0.25em;
        margin-right: 0.25em;
    }
    
    .iborrainputfile {
        font-size:16px; 
        font-weight:normal;
        font-family: 'Lato';
    }
    
    /* style 1 */
    
    .inputfile-1 + label {
        color: #fff;
        background-color: #00b297;
        border-color: #009981;
        cursor: pointer;
        display: inline-block;
        font-weight: normal;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        user-select: none;
        border: 1px solid transparent;
        padding: 10px 12px;
        font-size: 0.875rem;
        line-height: 1.25;
        border-radius: 3px;
        transition: all 0.15s ease-in-out;
    }
    
    .inputfile-1:focus + label,
    .inputfile-1.has-focus + label,
    .inputfile-1 + label:hover {
        color: #fff;
        background-color: #008c77;
        border-color: #006656;
    }
</style>

<div class="br-mainpanel" style="position: relative;">

  {% include 'bandeja_es/menu.html' %}


<div class="br-pagebody pd-x-20 pd-sm-x-30">
    <div class="card bd-0 shadow-base">
        <div class="br-section-wrapper">
         <form method="post" class="form-group mg-t-20" id="form_paquete" >{% csrf_token %}

                <div id="wizard2" role="application" class="wizard clearfix">
                        <div class="steps clearfix">
                            <ul role="tablist">
                            <li role="tab"  class="disabled" aria-disabled="false" aria-selected="true">
                                <a id="wizard2-t-0" href="#wizard2-h-0" aria-controls="wizard2-p-0">
                                    <span class="current-info audible">Paso: </span>
                                    <span class="number">1</span> 
                                    <span class="title">Configurar Destinatarios</span>
                                </a>
                            </li>
                            <li role="tab"class="first current" aria-disabled="true">
                                    <a id="wizard2-t-1" href="#wizard2-h-1" aria-controls="wizard2-p-1">
                                        <span class="number">2</span> 
                                        <span class="title">Adjuntar Archivos</span>
                                    </a>
                                </li>        
                            </ul>            
                        </div>
                        <div class="col-md-12" >
                          <div class="col-md-12" >
                         
                              <div id="tablaVersiones" style="background-color: rgba(176, 182, 176, 0.603); border-radius: 3px; padding: 10px;" >
                                  <table class="records_list table table-striped table-bordered table-hover dataTable no-footer table-primary" style="width:100%;">
                                      <thead>
                                         
                                          <tr>
                                              <th class="tx-10-force tx-mont tx-medium "style="text-align: center; color: white;"> Código </th>
                                              <th class="tx-10-force tx-mont tx-medium "style="text-align: center; color: white;"> Descripción </th>
                                              <th class="tx-10-force tx-mont tx-medium "style="text-align: center; color: white;"> Especialidad </th>
                                              <th class="tx-10-force tx-mont tx-medium "style="text-align: center; color: white;"> Revisión </th>
                                               {% if request.user.perfil.rol_usuario >= 4 and request.user.perfil.rol_usuario < 6  %}                                                       
                                              <th class="tx-10-force tx-mont tx-medium "style="text-align: center; color: white;"> Estado </th>
                                                    
                                               {% elif request.user.perfil.rol_usuario >= 1 and request.user.perfil.rol_usuario < 3 %}
                                              <th class="tx-10-force tx-mont tx-medium "style="text-align: center; color: white;"> Estado </th>                  
                                               {% endif %}  
                                              
                                              <th class="tx-10-force tx-mont tx-medium "style="text-align: center; color: white;"></th>
                                              <th class="tx-10-force tx-mont tx-medium "style="text-align: center; color: white;"></th>


                                          </tr>
                                      </thead>
                                        <tbody>
                                        {% for version in versiones %}
                                            <tr>
                                              <td style="text-align: center;border: 2px;border-color: grey; color: black;" > {{version.prev_documento_fk}} </td>
                                              <td style="text-align: center;border: 2px;border-color: grey; color: black;" > {{version.prev_documento_fk.Descripcion}} </td>
                                              <td style="text-align: center;border: 2px;border-color: grey; color: black;" > {{version.prev_documento_fk.Especialidad}} </td>
                                              <td style="text-align: center;border: 2px;border-color: grey; color: black;"> {{version.get_prev_revision_display}} </td>
                                               {% if request.user.perfil.rol_usuario >= 4 and request.user.perfil.rol_usuario < 6  %}                                                       
                                              <td style="text-align: center;border: 2px;border-color: grey; color: black;"> {{version.get_prev_estado_contratista_display}} </td>
                                                    
                                                   
                                               {% elif request.user.perfil.rol_usuario >= 1 and request.user.perfil.rol_usuario < 3 %}
                                                      <td style="text-align: center;border: 2px;border-color: grey; color: black;"> {{version.get_prev_estado_cliente_display}} </td>
                                                   
                                               {% endif %}  
                                              <td style="text-align: center;border: 2px;border-color: grey; color: black;"> <a onclick="JavaScript:window.open('{% url 'popup-version-update' version.pk paquete_pk %}','subir datos','toolbar=no,status=no,scrollbars=no,location=no,menubar=no,directories=no,resizable=yes,width=450,height=620,top=100,left=600');"><i class="fa fa-pencil"></i></a> </td>
                                              <td style="text-align: center;border: 2px;border-color: grey; color: black;"> <a href="{% url 'delete-prev-version' version.pk paquete_pk %}" onclick="confirm('Estás por eliminar esta versión. Estás seguro ?')"><i class="icon ion-trash-a"></i></a></td>

                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                      
                                    </table>
                                    <a class="btn btn-warning mg-x-10" type="button" onclick="JavaScript:window.open('{% url 'popup-version' paquete_pk %}','subir datos','toolbar=no,status=no,scrollbars=no,location=no,menubar=no,directories=no,resizable=yes,width=450,height=620,top=100,left=600');"><i class="icon ion-plus mg-r-2"></i> Agregar Versión</a>
                                    <input type="submit" class="mg-x-10 btn btn-teal  float-left" value="Enviar"/>
                                    <a class="mg-x-10"href="{% url 'borrador-crear' paquete_pk %}"><button type="button" class="btn btn-primary float-left"><i class="icon ion-bookmark mg-r-2"></i> Guardar en Borrador</button></a>
                                
                              </div>
                             
                          </div>
                          <div class="col-md-12" style="overflow-y: scroll; height: 500px;margin-top:30px;">
                        
                                <div id="app" style="background-color: rgba(176, 182, 176, 0.603); border-radius: 3px; padding: 10px;">
                                  
                                  <table class=" table table-striped table-bordered table-hover dataTable no-footer table-primary">
                                      <thead>
                                          <tr>
                                           <td colspan="3">
                                                <input type="file" name="file-1" id="file-upload" class="inputfile inputfile-1" data-multiple-caption="{count} archivos seleccionados"/>
                                                <label for="file-upload" style="
                                                margin-bottom: 0px;
                                                padding-bottom: 8px;
                                            ">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="iborrainputfile" width="20" height="17" viewBox="0 0 20 17"><path d="M10 0l-5.2 4.9h3.3v5.1h3.8v-5.1h3.3l-5.2-4.9zm9.3 11.5l-3.2-2.1h-2l3.4 2.6h-3.5c-.1 0-.2.1-.2.1l-.8 2.3h-6l-.8-2.2c-.1-.1-.1-.2-.2-.2h-3.6l3.4-2.6h-2l-3.2 2.1c-.4.3-.7 1-.6 1.5l.6 3.1c.1.5.7.9 1.2.9h16.3c.6 0 1.1-.4 1.3-.9l.6-3.1c.1-.5-.2-1.2-.7-1.5z"></path></svg>
                                                <span class="iborrainputfile">Seleccionar archivo</span>
                                                </label>
                                                
                                              
                                                <button @click="adjuntar_arch" class="btn btn-danger" type="button" :disabled="loading == 1">
                                                  <span v-if="loading == 1" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                                      [[ buttonText ]]
                                                </button>
                                            </td>
                                            
                                            <td colspan="3"> 
                                                <a v-on:click="cargar_val" class="btn btn-warning" type="button"><i class="icon ion-plus mg-r-2"></i> Cargar Versiones </a>
                                            </td>
                                            
                                            <td colspan="3">
                                               
                                             <a href="https://plannit-spaces.sfo3.digitaloceanspaces.com/PLANNIT-PLANTILLA_MULTICARGA.xlsx">
                                                <button class="btn btn-success"><i class="fa fa-download mg-r-10"></i> Descargar plantilla</button>
                                             </a>
                                            </td>
                                          </tr>
                                          <tr>
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"> Código </th>
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"> Descripción </th>
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"> Especialidad </th>
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"> Revisión </th>
                                               {% if request.user.perfil.rol_usuario >= 4 and request.user.perfil.rol_usuario < 6  %}                                                       
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"> Estado </th>
                                                    
                                               {% elif request.user.perfil.rol_usuario >= 1 and request.user.perfil.rol_usuario < 3 %}
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"> Estado </th>                  
                                               {% endif %}  
                                              
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;">Campo</th>
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"></th>
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"></th>
                                              <th class="tx-10-force tx-mont tx-medium hidden-xs-down"style="text-align: center; color: white;"></th>


                                          </tr>
                                      </thead>
                                      
                                        <tbody>
                                         
                                            <tr v-for="(version, index) in versiones" :key="index">
                                                <td > [[ version.Codigo_documento ]]</td>
                                                <td > [[ version.Descripcion ]]</td>
                                                <td > [[ version.Especialidad ]]</td>
                                                <td > [[ version.Tipo_Documento ]]</td>
                                                <td > [[ version.fecha_Emision_0 | moment ]]</td>
                                                <td > [[ version.fecha_Emision_B | moment ]]</td> 
                                                <td>
                                                    <input type="file" class="inputfile inputfile-1"name="file" id="file-2">
                                                        <label for="file-1" style="margin-bottom: 0px;padding-bottom: 8px;">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="iborrainputfile" width="20" height="17" viewBox="0 0 20 17"><path d="M10 0l-5.2 4.9h3.3v5.1h3.8v-5.1h3.3l-5.2-4.9zm9.3 11.5l-3.2-2.1h-2l3.4 2.6h-3.5c-.1 0-.2.1-.2.1l-.8 2.3h-6l-.8-2.2c-.1-.1-.1-.2-.2-.2h-3.6l3.4-2.6h-2l-3.2 2.1c-.4.3-.7 1-.6 1.5l.6 3.1c.1.5.7.9 1.2.9h16.3c.6 0 1.1-.4 1.3-.9l.6-3.1c.1-.5-.2-1.2-.7-1.5z"></path></svg>
                                                        <span class="iborrainputfile">Seleccionar archivo</span>
                                                        </label>
                                                </td>
                                                <td style="text-align: center;border: 2px;border-color: grey; color: black;"> 
                                                    <div 
                                                    value="verificar" 
                                                    :key="index" 
                                                    :class="{ 'btn btn-outline-success pd-b-0': !send && activeIndex !== index, 'spinner-border text-primary' : activeIndex === index }" 
                                                    role="status" 
                                                    @click="cargar_val(version, index)" 
                                                    >
                                                  
                                                    <label v-if="!send && activeIndex !== index">&check;</label>
                                                    <label v-if="activeIndex === index"></label>
                                                    </div>
                                                </td>
                                                <td style="text-align: center;border: 2px;border-color: grey; color: black;"> <a href="" ><i class="icon ion-trash-a"></i></a></td>
                                            </tr>  

                                        </tbody>
                                        
                                    </table>
                                </div>
                                    
                                </div>
                        
                        </div>
                </div>
                
            </form>
        </div>
    </div>     

</div>
  
  </div>

<script language='javascript'>
var t;
function doLoad() {
t = setTimeout("window.close()",1000);
}

</script>
<script type="text/javascript">
function refreshAndClose() {
    window.opener.location.reload(true);
    window.close();
}
</script>
<script>
    window.onunload = refreshParent;
    function refreshParent() {
      window.opener.location.reload();
    }
</script>
<script>

var app = new Vue({
    
  el: '#app',
  delimiters: [ '[[' ,  ']]' ],
  data: {
    versiones: [],
    loading: 0,
    send: false,
    buttonText : 'Subir Archivo',
    activeIndex: null,
  },
//   computed: {
//     classObject: function(index){
//         return {
//             'btn btn-success': !this.send && this.activeIndex !== index,
//             'spinner-border text-primary' : activeIndex === index
//         }
//     }
//   },
  methods:{
        adjuntar_arch: function() {
            this.loading = 1;
            this.buttonText = 'Subiendo...';

            let formData = new FormData();
            const file = document.getElementById('file-upload')
            formData.append('file', file.files[0]);

            fetch("{% url 'vue-file-import' %}", {
                method: 'POST',
                body: formData
            }).then(
                async response => {
                    const result = await response.json();
                    this.versiones = result.data;
                    console.log(this.versiones)
                    this.loading = 0;
                    this.buttonText = 'Subir Archivo';

                    }
            ).catch(
                error => {
                    console.log('Error:', error);
                    this.loading = 0;
                    this.buttonText = 'Subir Archivo';

                }
            )
        },

        cargar_val: function(version, index) {
            this.activeIndex = index
            console.log(index)

            let formData = new FormData();
            formData.append('Codigo_documento', version['Codigo_documento'])
            formData.append('Descripcion', version['Descripcion'])
            formData.append('Especialidad', version['Especialidad'])
            formData.append('Tipo_Documento', version['Tipo_Documento'])
            formData.append('fecha_Emision_0', version['fecha_Emision_0'])
            formData.append('fecha_Emision_B', version['fecha_Emision_B'])


            fetch("{% url 'vue-version-check' %}", {
                method: 'POST',
                body: formData
            }).then(
                response => {
                    const result = response.json();
                    console.log(result);
                    this.activeIndex = null;

                    }
            ).catch(
                error => {
                    console.log(error);
                }
            )

        }
    }
})
</script>

 <script>
    Vue.component('message', {
        template: '#message',
        props: {
            type: {
                type: String
            },
            header: {
                type: String
            },
        }, 

    })


</script>
<script>
    'use strict';

    ;( function ( document, window, index )
    {
        var inputs = document.querySelectorAll( '.inputfile' );
        Array.prototype.forEach.call( inputs, function( input )
        {
            var label	 = input.nextElementSibling,
                labelVal = label.innerHTML;
    
            input.addEventListener( 'change', function( e )
            {
                var fileName = '';
                if( this.files && this.files.length > 1 )
                    fileName = ( this.getAttribute( 'data-multiple-caption' ) || '' ).replace( '{count}', this.files.length );
                else
                    fileName = e.target.value.split( '\\' ).pop();
    
                if( fileName )
                    label.querySelector( 'span' ).innerHTML = fileName;
                else
                    label.innerHTML = labelVal;
            });
        });
    }( document, window, 0 ));
</script>
{% endblock content %}